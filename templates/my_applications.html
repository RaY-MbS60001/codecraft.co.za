{% extends "base.html" %}

{% block title %}My Applications{% endblock %}

{% block content %}
<style>
    @import url("{{ url_for('static', filename='css/my-applications.css') }}");
</style>
<div class="applications-container">
    <!-- Header Section -->
    <div class="applications-header">
        <div class="header-content">
            <h1 class="page-title">
                <i class="icon-briefcase"></i>
                My Applications
            </h1>
            <p class="page-subtitle">Track your learnership applications and email responses</p>
        </div>

        <div class="header-actions">
            <button onclick="refreshGmailStatuses()" class="btn btn-primary" id="refreshBtn">
                <i class="icon-refresh"></i>
                <span>Refresh Email Status</span>
            </button>

            <button onclick="checkAllResponses()" class="btn btn-outline">
                <i class="icon-mail"></i>
                <span>Check Responses</span>
            </button>
        </div>
    </div>

    <!-- Statistics Dashboard -->
    <div class="stats-dashboard">
        <div class="stat-card">
            <div class="stat-icon">üìä</div>
            <div class="stat-info">
                <div class="stat-number">{{ stats.total }}</div>
                <div class="stat-label">Total Applications</div>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">üì§</div>
            <div class="stat-info">
                <div class="stat-number">{{ stats.sent_emails }}</div>
                <div class="stat-label">Emails Sent</div>
            </div>
        </div>

        <div class="stat-card success">
            <div class="stat-icon">üí¨</div>
            <div class="stat-info">
                <div class="stat-number">{{ stats.responses_received }}</div>
                <div class="stat-label">Responses Received</div>
            </div>
        </div>

        <div class="stat-card warning">
            <div class="stat-icon">‚è≥</div>
            <div class="stat-info">
                <div class="stat-number">{{ stats.pending_responses }}</div>
                <div class="stat-label">Awaiting Response</div>
            </div>
        </div>

        <div class="stat-card info">
            <div class="stat-icon">üîó</div>
            <div class="stat-info">
                <div class="stat-number">{{ stats.gmail_tracked }}</div>
                <div class="stat-label">Gmail Tracked</div>
            </div>
        </div>

        {% if stats.failed_emails > 0 %}
        <div class="stat-card danger">
            <div class="stat-icon">‚ùå</div>
            <div class="stat-info">
                <div class="stat-number">{{ stats.failed_emails }}</div>
                <div class="stat-label">Failed Emails</div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Update Banner -->
    {% if needs_update > 0 %}
    <div class="update-banner">
        <div class="banner-content">
            <i class="icon-info"></i>
            <span>{{ needs_update }} applications may have status updates available</span>
        </div>
        <button onclick="autoUpdateStatuses()" class="btn btn-sm btn-primary">
            Update All
        </button>
    </div>
    {% endif %}

    <!-- Filter Tabs -->
    <div class="filter-tabs">
        <button class="tab-btn active" onclick="showTab('all')">
            All Applications <span class="count">{{ stats.total }}</span>
        </button>
        <button class="tab-btn" onclick="showTab('sent')">
            Email Sent <span class="count">{{ email_status_groups.sent|length + email_status_groups.delivered|length +
                email_status_groups.read|length }}</span>
        </button>
        <button class="tab-btn" onclick="showTab('responded')">
            Responses <span class="count">{{ email_status_groups.responded|length }}</span>
        </button>
        <button class="tab-btn" onclick="showTab('pending')">
            Pending <span class="count">{{ grouped_applications.pending|length }}</span>
        </button>
        <button class="tab-btn" onclick="showTab('failed')">
            Failed <span class="count">{{ email_status_groups.failed|length }}</span>
        </button>
    </div>

    <!-- Applications List -->
    <div class="applications-list" id="applicationsList">
        {% if applications %}
        {% for app in applications %}
        <div class="application-card" data-app-id="{{ app.id }}" data-status="{{ app.status }}"
            data-email-status="{{ app.email_status or 'draft' }}">
            <!-- Application Header -->
            <div class="app-header">
                <div class="app-title-section">
                    <h3 class="app-title">{{ app.learnership_name or 'Application' }}</h3>
                    <p class="app-company">{{ app.company_name or 'Company not specified' }}</p>
                </div>

                <div class="app-status-section">
                    <!-- Application Status Badge -->
                    <span class="status-badge status-{{ app.status }}">
                        <i class="status-icon"></i>
                        {{ app.status.title() }}
                    </span>

                    <!-- Email Status Badge -->
                    {% set email_status = app.email_status or 'draft' %}
                    <span class="email-status-badge email-{{ email_status }}">
                        <i class="email-status-icon"></i>
                        {% if email_status == 'draft' %}üìù Draft
                        {% elif email_status == 'sent' %}üì§ Sent
                        {% elif email_status == 'delivered' %}‚úÖ Delivered
                        {% elif email_status == 'read' %}üëÅÔ∏è Read
                        {% elif email_status == 'responded' %}üí¨ Response
                        {% elif email_status == 'failed' %}‚ùå Failed
                        {% else %}üìù {{ email_status.title() }}
                        {% endif %}
                    </span>
                </div>
            </div>

            <!-- Application Timeline -->
            <div class="app-timeline">
                <div class="timeline-item">
                    <div class="timeline-icon">üìù</div>
                    <div class="timeline-content">
                        <div class="timeline-title">Application Created</div>
                        <div class="timeline-date">
                            {{ app.submitted_at.strftime('%b %d, %Y at %I:%M %p') if app.submitted_at else 'Unknown
                            date' }}
                        </div>
                    </div>
                </div>

                {% if app.sent_at %}
                <div class="timeline-item">
                    <div class="timeline-icon">üì§</div>
                    <div class="timeline-content">
                        <div class="timeline-title">Email Sent</div>
                        <div class="timeline-date">{{ app.sent_at.strftime('%b %d, %Y at %I:%M %p') }}</div>
                    </div>
                </div>
                {% endif %}

                {% if app.has_response and app.response_received_at %}
                <div class="timeline-item highlight">
                    <div class="timeline-icon">üí¨</div>
                    <div class="timeline-content">
                        <div class="timeline-title">Response Received</div>
                        <div class="timeline-date">
                            {{ app.response_received_at.strftime('%b %d, %Y at %I:%M %p') }}
                            {% if app.response_thread_count %}
                            <span class="response-count">({{ app.response_thread_count }} message{{ 's' if
                                app.response_thread_count != 1 else '' }})</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Application Details -->
            <div class="app-details">
                {% if app.sent_at %}
                <div class="detail-item">
                    <span class="detail-label">Days Since Sent:</span>
                    <span class="detail-value">{{ app.sent_at | days_ago }}</span>
                </div>
                {% endif %}

                {% if app.gmail_message_id %}
                <div class="detail-item">
                    <span class="detail-label">Gmail Tracking:</span>
                    <span class="detail-value success">
                        <i class="icon-check"></i> Enabled
                    </span>
                </div>
                {% endif %}
            </div>

            <!-- Application Actions -->
            <div class="app-actions">
                <button onclick="checkSingleStatus({{ app.id }})" class="action-btn btn-outline">
                    <i class="icon-refresh"></i>
                    Check Status
                </button>

                {% if app.gmail_thread_id %}
                <a href="https://mail.google.com/mail/u/0/#inbox/{{ app.gmail_thread_id }}" target="_blank"
                    class="action-btn btn-primary">
                    <i class="icon-mail"></i>
                    View in Gmail
                </a>
                {% endif %}

                <button onclick="viewApplicationDetails({{ app.id }})" class="action-btn btn-secondary">
                    <i class="icon-eye"></i>
                    View Details
                </button>

                {% if app.email_status == 'failed' %}
                <button onclick="retryApplication({{ app.id }})" class="action-btn btn-warning">
                    <i class="icon-repeat"></i>
                    Retry Send
                </button>
                {% endif %}
            </div>

            <!-- Response Highlight -->
            {% if app.has_response %}
            <div class="response-highlight">
                <div class="response-icon">üéâ</div>
                <div class="response-text">
                    <strong>Great news!</strong> You've received a response to this application.
                    <a href="https://mail.google.com/mail/u/0/#inbox/{{ app.gmail_thread_id }}" target="_blank">
                        View conversation ‚Üí
                    </a>
                </div>
            </div>
            {% endif %}
        </div>
        {% endfor %}
        {% else %}
        <!-- Empty State -->
        <div class="empty-state">
            <div class="empty-icon">üìÑ</div>
            <h3>No Applications Yet</h3>
            <p>You haven't submitted any applications yet. Start applying to learnerships to see them here!</p>
            <a href="{{ url_for('learnerships') }}" class="btn btn-primary">
                <i class="icon-plus"></i>
                Browse Learnerships
            </a>
        </div>
        {% endif %}
    </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay" style="display: none;">
    <div class="loading-content">
        <div class="loading-spinner"></div>
        <p>Updating email statuses...</p>
    </div>
</div>

<!-- Application Details Modal -->
<div id="appDetailsModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Application Details</h3>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body" id="modalBody">
            <!-- Dynamic content will be loaded here -->
        </div>
    </div>
</div>

<script>
    // Tab Management
    function showTab(tabName) {
        const cards = document.querySelectorAll('.application-card');
        const tabs = document.querySelectorAll('.tab-btn');

        // Update active tab
        tabs.forEach(tab => tab.classList.remove('active'));
        event.target.classList.add('active');

        // Filter cards
        cards.forEach(card => {
            const status = card.dataset.status;
            const emailStatus = card.dataset.emailStatus;

            let show = false;

            switch (tabName) {
                case 'all':
                    show = true;
                    break;
                case 'sent':
                    show = ['sent', 'delivered', 'read'].includes(emailStatus);
                    break;
                case 'responded':
                    show = emailStatus === 'responded';
                    break;
                case 'pending':
                    show = status === 'pending';
                    break;
                case 'failed':
                    show = emailStatus === 'failed';
                    break;
            }

            card.style.display = show ? 'block' : 'none';
        });
    }

    // Gmail Status Functions
    function refreshGmailStatuses() {
        showLoading('Refreshing email statuses...');

        fetch('/update_application_statuses', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                if (data.success) {
                    showNotification(`Updated ${data.updated_count} applications!`, 'success');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showNotification('Error updating statuses: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                hideLoading();
                console.error('Error:', error);
                showNotification('Network error while updating statuses', 'error');
            });
    }

    function checkAllResponses() {
        showLoading('Checking for new responses...');

        fetch('/bulk-check-responses')
            .then(response => response.json())
            .then(data => {
                hideLoading();
                if (data.success) {
                    if (data.responses_found > 0) {
                        showNotification(`Found ${data.responses_found} new responses! üéâ`, 'success');
                        setTimeout(() => location.reload(), 2000);
                    } else {
                        showNotification('No new responses found', 'info');
                    }
                } else {
                    showNotification('Error checking responses: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                hideLoading();
                console.error('Error:', error);
                showNotification('Network error while checking responses', 'error');
            });
    }

    function checkSingleStatus(appId) {
        const button = event.target.closest('button');
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="icon-loading"></i> Checking...';
        button.disabled = true;

        fetch(`/api/application_status/${appId}`)
            .then(response => response.json())
            .then(data => {
                button.innerHTML = originalText;
                button.disabled = false;

                console.log('Status data:', data);
                showNotification('Status updated!', 'info');

                // Update the card with new status if needed
                // You can add DOM manipulation here to update the status badges
            })
            .catch(error => {
                button.innerHTML = originalText;
                button.disabled = false;
                console.error('Error:', error);
                showNotification('Error checking status', 'error');
            });
    }

    function autoUpdateStatuses() {
        showLoading('Auto-updating recent applications...');

        fetch('/auto-update-gmail-status')
            .then(response => response.json())
            .then(data => {
                hideLoading();
                if (data.success) {
                    showNotification(data.message, 'success');
                    if (data.updated_count > 0) {
                        setTimeout(() => location.reload(), 1500);
                    }
                } else {
                    showNotification('Error: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                hideLoading();
                console.error('Error:', error);
                showNotification('Network error during auto-update', 'error');
            });
    }

    // UI Helper Functions
    function showLoading(message = 'Loading...') {
        const overlay = document.getElementById('loadingOverlay');
        const text = overlay.querySelector('p');
        text.textContent = message;
        overlay.style.display = 'flex';
    }

    function hideLoading() {
        document.getElementById('loadingOverlay').style.display = 'none';
    }

    function showNotification(message, type = 'info') {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.innerHTML = `
        <div class="notification-content">
            <span>${message}</span>
            <button onclick="this.parentElement.parentElement.remove()">&times;</button>
        </div>
    `;

        // Add to page
        document.body.appendChild(notification);

        // Auto remove after 5 seconds
        setTimeout(() => {
            if (notification.parentElement) {
                notification.remove();
            }
        }, 5000);
    }

    function viewApplicationDetails(appId) {
        // Show modal with application details
        const modal = document.getElementById('appDetailsModal');
        const modalBody = document.getElementById('modalBody');

        modalBody.innerHTML = '<div class="loading-spinner"></div>';
        modal.style.display = 'flex';

        fetch(`/api/application_status/${appId}`)
            .then(response => response.json())
            .then(data => {
                modalBody.innerHTML = `
            <div class="detail-grid">
                <div class="detail-row">
                    <span class="label">Application ID:</span>
                    <span class="value">${data.id}</span>
                </div>
                <div class="detail-row">
                    <span class="label">Status:</span>
                    <span class="value">${data.status}</span>
                </div>
                <div class="detail-row">
                    <span class="label">Email Status:</span>
                    <span class="value">${data.email_status}</span>
                </div>
                ${data.sent_at ? `
                <div class="detail-row">
                    <span class="label">Sent Date:</span>
                    <span class="value">${new Date(data.sent_at).toLocaleString()}</span>
                </div>` : ''}
                ${data.gmail_message_id ? `
                <div class="detail-row">
                    <span class="label">Gmail Message ID:</span>
                    <span class="value font-mono">${data.gmail_message_id}</span>
                </div>` : ''}
                ${data.has_response ? `
                <div class="detail-row">
                    <span class="label">Response Count:</span>
                    <span class="value">${data.response_count} messages</span>
                </div>` : ''}
                ${data.days_since_sent ? `
                <div class="detail-row">
                    <span class="label">Days Since Sent:</span>
                    <span class="value">${data.days_since_sent} days</span>
                </div>` : ''}
            </div>
            <div class="modal-actions">
                ${data.gmail_url ? `<a href="${data.gmail_url}" target="_blank" class="btn btn-primary">View in Gmail</a>` : ''}
                <button onclick="closeModal()" class="btn btn-secondary">Close</button>
            </div>
        `;
            })
            .catch(error => {
                modalBody.innerHTML = `<div class="error">Error loading details: ${error.message}</div>`;
            });
    }

    function closeModal() {
        document.getElementById('appDetailsModal').style.display = 'none';
    }

    function retryApplication(appId) {
        if (confirm('Are you sure you want to retry sending this application?')) {
            showNotification('Retry functionality coming soon!', 'info');
        }
    }

    // Close modal when clicking outside
    window.onclick = function (event) {
        const modal = document.getElementById('appDetailsModal');
        if (event.target === modal) {
            closeModal();
        }
    }
</script>
{% endblock %}