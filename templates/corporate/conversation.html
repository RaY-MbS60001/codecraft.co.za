{% extends "base.html" %}
{% block title %}Conversation - {{ conversation.subject }} - CodeCraftCo{% endblock %}

{% block additional_css %}
<style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');

    :root {
        --background: #1e293b;
        --surface: #334155;
        --surface-hover: #475569;
        --surface-alt: #64748b;
        --border-color: #475569;
        --text-primary: #f8fafc;
        --text-secondary: #cbd5e1;
        --text-tertiary: #94a3b8;
        --primary-color: #3b82f6;
        --primary-hover: #2563eb;
        --primary-light: rgba(59, 130, 246, 0.15);
        --success-color: #10b981;
        --success-hover: #059669;
        --success-light: rgba(16, 185, 129, 0.15);
        --warning-color: #f59e0b;
        --warning-hover: #d97706;
        --warning-light: rgba(245, 158, 11, 0.15);
        --danger-color: #ef4444;
        --danger-hover: #dc2626;
        --danger-light: rgba(239, 68, 68, 0.15);
        --info-color: #06b6d4;
        --info-light: rgba(6, 182, 212, 0.15);
        --premium: #f093fb;
        --premium-secondary: #f5576c;
        --premium-light: rgba(240, 147, 251, 0.15);
        --purple: #8b5cf6;
        --purple-hover: #7c3aed;
        --radius-sm: 4px;
        --radius-md: 8px;
        --radius-lg: 12px;
        --radius-full: 50%;
        --transition-fast: 0.15s ease;
        --transition-normal: 0.3s ease;
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -1px rgba(0, 0, 0, 0.3);
        --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.4), 0 4px 6px -2px rgba(0, 0, 0, 0.3);
        --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.5), 0 10px 10px -5px rgba(0, 0, 0, 0.4);
        --shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.6);
    }

    body {
        background: var(--background);
        color: var(--text-primary);
        font-family: 'Inter', sans-serif;
        margin: 0;
    }

    /* Navigation */
    .dashboard-nav {
        background: var(--surface);
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 2rem;
        box-shadow: var(--shadow);
        position: sticky;
        top: 0;
        z-index: 100;
    }

    .nav-left .nav-logo {
        margin: 0;
        display: flex;
        align-items: center;
    }

    .nav-logo a {
        text-decoration: none;
        display: flex;
        align-items: center;
    }

    .logo-container {
        display: flex;
        align-items: center;
        gap: 8px;
        transform: translateY(16px);
    }

    .word {
        display: flex;
        align-items: center;
        gap: 2px;
    }

    .letter-box {
        width: 35px;
        height: 35px;
        background-color: rgba(51, 51, 51, 0.9);
        border: 2px solid #fff;
        display: flex;
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(10px);
        transition: all var(--transition-normal);
    }

    .letter-box:hover {
        transform: scale(1.05) rotate(-3deg);
    }

    .letter-box.red {
        box-shadow: 0 0 12px #ff0000, 0 0 24px rgba(255, 0, 0, 0.4);
    }

    .letter-box.blue {
        box-shadow: 0 0 12px #0099ff, 0 0 24px rgba(0, 153, 255, 0.4);
    }

    .letter-box.orange {
        box-shadow: 0 0 12px #ff8800, 0 0 24px rgba(255, 136, 0, 0.4);
    }

    .letter {
        font-size: 20px;
        font-weight: bold;
        color: #fff;
        text-align: center;
        font-family: 'Arial', sans-serif;
        line-height: 1;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
    }

    .word-text {
        font-size: 20px;
        font-weight: normal;
        color: #fff;
        margin-left: 3px;
        font-family: 'Arial', sans-serif;
        text-shadow: 0 0 5px rgba(255, 255, 255, 0.3);
        line-height: 1;
    }

    .nav-right {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .nav-corporate-link {
        display: flex;
        align-items: center;
        gap: 8px;
        text-decoration: none;
        color: white;
        padding: 8px 16px;
        border-radius: var(--radius-md);
        transition: all var(--transition-normal);
        font-weight: 500;
        position: relative;
    }

    .nav-corporate-link.dashboard {
        background: linear-gradient(45deg, var(--info-color) 0%, #0891b2 100%);
        box-shadow: 0 2px 8px rgba(6, 182, 212, 0.3);
    }

    .nav-corporate-link.inbox {
        background: linear-gradient(45deg, var(--purple) 0%, var(--purple-hover) 100%);
        box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);
    }

    .nav-corporate-link.calendar {
        background: linear-gradient(45deg, #10b981 0%, #059669 100%);
        box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
    }

    .nav-corporate-link.analytics {
        background: linear-gradient(45deg, #f59e0b 0%, #d97706 100%);
        box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
    }

    .nav-corporate-link:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        color: white;
        text-decoration: none;
    }

    /* Inbox Badge */
    .inbox-badge {
        position: absolute;
        top: -6px;
        right: -6px;
        background: var(--danger-color);
        color: white;
        border-radius: 50%;
        width: 18px;
        height: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
        font-weight: 600;
        border: 2px solid var(--surface);
        animation: pulse-notification 2s ease-in-out infinite;
    }

    @keyframes pulse-notification {
        0%, 100% {
            transform: scale(1);
            box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
        }
        50% {
            transform: scale(1.1);
            box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
        }
    }

    .user-menu {
        position: relative;
        display: flex;
        align-items: center;
    }

    .user-menu-trigger {
        display: flex;
        align-items: center;
        gap: 8px;
        background: none;
        border: none;
        cursor: pointer;
        color: white;
        padding: 8px 12px;
        border-radius: var(--radius-md);
        transition: all var(--transition-normal);
    }

    .user-menu-trigger:hover {
        background: var(--surface-hover);
    }

    .user-avatar-small span {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: var(--surface-hover);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        border: 2px solid var(--border-color);
    }

    .user-name {
        font-size: 0.9rem;
        color: white;
        font-weight: 500;
    }

    .chevron-icon {
        transition: transform var(--transition-normal);
        color: var(--text-secondary);
    }

    .user-menu-dropdown {
        display: none;
        position: absolute;
        right: 0;
        top: 48px;
        background: var(--surface);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        min-width: 200px;
        z-index: 1001;
        box-shadow: var(--shadow-lg);
        backdrop-filter: blur(10px);
    }

    .user-menu-trigger:hover+.user-menu-dropdown,
    .user-menu-dropdown:hover {
        display: block;
    }

    .menu-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px 16px;
        color: white;
        text-decoration: none;
        transition: background var(--transition-fast);
        font-size: 0.9rem;
        position: relative;
    }

    .menu-item:hover {
        background: var(--surface-hover);
        color: white;
        text-decoration: none;
    }

    .menu-item i {
        width: 16px;
    }

    .menu-divider {
        height: 1px;
        background: var(--border-color);
        margin: 0;
    }

    .menu-item.logout {
        color: var(--danger-color) !important;
    }

    .menu-item.logout:hover {
        background: var(--danger-light) !important;
        color: var(--danger-color) !important;
    }

    /* Menu Badge */
    .menu-badge {
        margin-left: auto;
        background: var(--danger-color);
        color: white;
        border-radius: 50%;
        width: 16px;
        height: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
        font-weight: 600;
    }

    /* Back Button */
    .back-btn {
        color: var(--text-secondary);
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border-radius: var(--radius-sm);
        transition: all var(--transition-normal);
        font-weight: 500;
    }

    .back-btn:hover {
        background: var(--surface-hover);
        color: var(--text-primary);
        text-decoration: none;
    }

    /* Main Content */
    .conversation-container {
        min-height: 100vh;
        background: var(--background);
        color: var(--text-primary);
    }

    .conversation-content {
        max-width: 1000px;
        margin: 0 auto;
        padding: 2rem;
    }

    .conversation-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 2rem;
        background: var(--surface);
        border-radius: var(--radius-lg);
        margin-bottom: 2rem;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
    }

    .conversation-title h1 {
        font-size: 1.5rem;
        margin: 0 0 0.5rem 0;
        color: var(--text-primary);
    }

    .conversation-title p {
        color: var(--text-secondary);
        margin: 0;
    }

    .conversation-actions {
        display: flex;
        gap: 1rem;
    }

    .messages-container {
        max-height: 60vh;
        overflow-y: auto;
        padding: 1.5rem;
        background: var(--surface);
        border-radius: var(--radius-lg);
        margin-bottom: 2rem;
        scroll-behavior: smooth;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
    }

    .message {
        margin-bottom: 2rem;
        max-width: 80%;
        animation: fadeInUp 0.5s ease-out;
    }

    .message.sent {
        margin-left: auto;
        margin-right: 0;
    }

    .message.received {
        margin-left: 0;
        margin-right: auto;
    }

    .message-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
        font-size: 0.85rem;
    }

    .message-sender {
        font-weight: 600;
        color: var(--text-secondary);
    }

    .message.sent .message-sender {
        color: var(--primary-color);
    }

    .message-time {
        color: var(--text-tertiary);
        font-size: 0.8rem;
    }

    .message-body {
        background: var(--surface-hover);
        padding: 1rem;
        border-radius: var(--radius-lg);
        line-height: 1.6;
        transition: all var(--transition-normal);
    }

    .message.sent .message-body {
        background: var(--primary-color);
        color: white;
    }

    .message-html {
        word-wrap: break-word;
    }

    .message-html * {
        max-width: 100%;
    }

    .message-text {
        white-space: pre-wrap;
        word-wrap: break-word;
    }

    .message-attachments {
        margin-top: 0.5rem;
        color: var(--text-tertiary);
        font-size: 0.85rem;
    }

    .reply-container {
        background: var(--surface);
        border-radius: var(--radius-lg);
        padding: 1.5rem;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
    }

    .reply-header h3 {
        margin: 0 0 1rem 0;
        font-size: 1.1rem;
        color: var(--text-primary);
    }

    .reply-textarea {
        width: 100%;
        min-height: 120px;
        padding: 1rem;
        background: var(--surface-hover);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        color: var(--text-primary);
        resize: vertical;
        font-family: inherit;
        transition: all var(--transition-normal);
    }

    .reply-textarea:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px var(--primary-light);
    }

    .reply-textarea::placeholder {
        color: var(--text-tertiary);
    }

    .reply-actions {
        display: flex;
        justify-content: space-between;
        margin-top: 1rem;
        gap: 1rem;
    }

    .btn {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: var(--radius-md);
        font-weight: 600;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all var(--transition-normal);
        cursor: pointer;
        font-family: inherit;
    }

    .btn-primary {
        background: var(--primary-color);
        color: white;
        box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
    }

    .btn-primary:hover {
        background: var(--primary-hover);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
        color: white;
        text-decoration: none;
    }

    .btn-secondary {
        background: var(--surface-alt);
        color: white;
        box-shadow: 0 4px 15px rgba(100, 116, 139, 0.3);
    }

    .btn-secondary:hover {
        background: var(--surface-hover);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(100, 116, 139, 0.4);
        color: white;
        text-decoration: none;
    }

    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        backdrop-filter: blur(4px);
    }

    .modal-content {
        background: var(--surface);
        padding: 2rem;
        border-radius: var(--radius-lg);
        max-width: 500px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: var(--shadow-xl);
        border: 1px solid var(--border-color);
    }

    .modal-content h3 {
        margin: 0 0 1.5rem 0;
        color: var(--text-primary);
    }

    .templates-list {
        margin-bottom: 1.5rem;
    }

    .template-item {
        padding: 1rem;
        background: var(--surface-hover);
        border-radius: var(--radius-md);
        margin-bottom: 1rem;
        cursor: pointer;
        transition: all var(--transition-normal);
        border: 1px solid rgba(148, 163, 184, 0.1);
    }

    .template-item:hover {
        background: var(--surface-alt);
        transform: translateY(-2px);
        box-shadow: var(--shadow);
    }

    .template-item h4 {
        margin: 0 0 0.5rem 0;
        font-size: 1rem;
        color: var(--text-primary);
    }

    .template-item p {
        margin: 0;
        color: var(--text-secondary);
        font-size: 0.9rem;
    }

    /* Scrollbar styling */
    .messages-container::-webkit-scrollbar {
        width: 8px;
    }

    .messages-container::-webkit-scrollbar-track {
        background: var(--surface-hover);
        border-radius: 4px;
    }

    .messages-container::-webkit-scrollbar-thumb {
        background: var(--surface-alt);
        border-radius: 4px;
    }

    .messages-container::-webkit-scrollbar-thumb:hover {
        background: var(--text-tertiary);
    }

    /* Footer */
    .main-footer {
        background: #1e293b;
        border-top: 1px solid var(--border-color);
        color: var(--text-secondary);
        padding: 20px 14px 14px;
        margin-top: 40px;
    }

    .footer-inner {
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        max-width: 1100px;
        margin: 0 auto;
        gap: 12px;
    }

    .footer-brand {
        flex: 1 1 200px;
        text-align: center;
    }

    .footer-brand .logo-container {
        justify-content: center;
        transform: scale(0.9);
        margin-bottom: 8px;
    }

    .footer-tagline {
        font-size: 0.8rem;
        color: var(--text-tertiary);
        margin-top: 3px;
    }

    .footer-links {
        flex: 1 1 280px;
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 6px 12px;
    }

    .footer-links a {
        color: var(--text-secondary);
        font-size: 0.82rem;
        text-decoration: none;
        transition: color 0.3s;
        padding: 4px 8px;
        border-radius: 4px;
    }

    .footer-links a:hover {
        color: var(--text-primary);
        background: rgba(248, 250, 252, 0.1);
    }

    .footer-social {
        flex: 1 1 160px;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 6px;
        margin-top: 2px;
    }

    .social-btn {
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        background: var(--surface-hover);
        color: white;
        font-size: 12px;
        text-decoration: none;
        transition: transform 0.25s ease, background 0.25s ease;
    }

    .social-btn:hover {
        transform: translateY(-2px);
    }

    .social-btn.linkedin:hover {
        background: #0077b5;
    }

    .social-btn.github:hover {
        background: #181717;
    }

    .social-btn.instagram:hover {
        background: radial-gradient(circle at 30% 107%, #fdf497 0%, #fd5949 45%, #d6249f 60%, #285AEB 90%);
    }

    .social-btn.facebook:hover {
        background: #1877f2;
    }

    .social-btn.whatsapp:hover {
        background: #25D366;
    }

    .footer-bottom {
        border-top: 1px solid var(--border-color);
        text-align: center;
        padding-top: 8px;
        margin-top: 8px;
        font-size: 0.75rem;
        color: var(--text-tertiary);
    }

    /* Animations */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Responsive */
    @media (max-width: 768px) {
        .dashboard-nav {
            padding: 0.5rem 1rem;
            flex-direction: column;
            gap: 0.5rem;
        }

        .nav-right {
            gap: 0.75rem;
            width: 100%;
            justify-content: center;
            flex-wrap: wrap;
        }

        .nav-corporate-link span {
            display: none;
        }

        .nav-corporate-link {
            padding: 8px;
            min-width: 40px;
            justify-content: center;
        }

        .inbox-badge {
            width: 16px;
            height: 16px;
            font-size: 0.6rem;
            top: -6px;
            right: -6px;
        }

        .user-name {
            display: none;
        }

        .conversation-content {
            padding: 1rem;
        }

        .conversation-header {
            flex-direction: column;
            gap: 1rem;
            text-align: center;
            padding: 1.5rem;
        }

        .conversation-actions {
            justify-content: center;
        }

        .messages-container {
            max-height: 50vh;
            padding: 1rem;
        }

        .message {
            max-width: 95%;
        }

        .reply-actions {
            flex-direction: column;
            gap: 0.75rem;
        }

        .footer-inner {
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
    }

    @media (max-width: 480px) {
        .conversation-content {
            padding: 0.5rem;
        }

        .conversation-header {
            padding: 1rem;
        }

        .conversation-title h1 {
            font-size: 1.2rem;
        }

        .message-body {
            padding: 0.75rem;
        }

        .reply-container {
            padding: 1rem;
        }

        .modal-content {
            padding: 1.5rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Navigation -->
<nav class="dashboard-nav">
    <div class="nav-left">
        <div class="nav-logo">
            <a href="{{ url_for('index') }}">
                <div class="logo-container">
                    <div class="word">
                        <div class="letter-box red">
                            <div class="letter">C</div>
                        </div>
                        <div class="word-text">ode</div>
                    </div>
                    <div class="word">
                        <div class="letter-box blue">
                            <div class="letter">C</div>
                        </div>
                        <div class="word-text">raft</div>
                    </div>
                    <div class="word">
                        <div class="letter-box orange">
                            <div class="letter">C</div>
                        </div>
                        <div class="word-text">o</div>
                    </div>
                </div>
            </a>
        </div>
        <a href="{{ url_for('corporate_inbox') }}" class="back-btn">
            <i class="fas fa-arrow-left"></i> Back to Inbox
        </a>
    </div>

    <div class="nav-right">
        <a href="{{ url_for('corporate_dashboard') }}" class="nav-corporate-link dashboard">
            <i class="fas fa-chart-line"></i>
            <span>Dashboard</span>
        </a>

        <a href="{{ url_for('corporate_inbox') }}" class="nav-corporate-link inbox" id="inboxNavLink">
            <i class="fas fa-envelope"></i>
            <span>Inbox</span>
            <span class="inbox-badge" id="navInboxBadge" style="display: none;">0</span>
        </a>

        <a href="{{ url_for('corporate_calendar') }}" class="nav-corporate-link calendar">
            <i class="fas fa-calendar-alt"></i>
            <span>Calendar</span>
        </a>

        <a href="{{ url_for('corporate_analytics') }}" class="nav-corporate-link analytics">
            <i class="fas fa-chart-bar"></i>
            <span>Analytics</span>
        </a>

        <div class="user-menu">
            <button class="user-menu-trigger" onclick="toggleUserMenu()">
                <div class="user-avatar-small">
                    <span>{{ (corporate_user.company_name[0].upper() if (corporate_user and corporate_user.company_name) else (corporate_user.full_name[0].upper() if (corporate_user and corporate_user.full_name) else 'C')) }}</span>
                </div>
                <span class="user-name">{{ (corporate_user.company_name[:20] if (corporate_user and corporate_user.company_name) else (corporate_user.full_name[:20] if (corporate_user and corporate_user.full_name) else 'Corporate User')) }}</span>
                <svg class="chevron-icon" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M4.646 6.646a.5.5 0 01.708 0L8 9.293l2.646-2.647a.5.5 0 01.708.708l-3 3a.5.5 0 01-.708 0l-3-3a.5.5 0 010-.708z" />
                </svg>
            </button>
            <div class="user-menu-dropdown" id="userMenuDropdown">
                <a href="{{ url_for('corporate_opportunities') }}" class="menu-item">
                    <i class="fas fa-briefcase"></i> My Opportunities
                </a>
                <a href="{{ url_for('corporate_applications') }}" class="menu-item">
                    <i class="fas fa-inbox"></i> Applications
                </a>
                <a href="{{ url_for('corporate_inbox') }}" class="menu-item">
                    <i class="fas fa-envelope"></i> Inbox
                    <span class="menu-badge" id="menuInboxBadge" style="display: none;">0</span>
                </a>
                <a href="{{ url_for('corporate_calendar') }}" class="menu-item">
                    <i class="fas fa-calendar-alt"></i> Calendar
                </a>
                <a href="{{ url_for('corporate_analytics') }}" class="menu-item">
                    <i class="fas fa-chart-bar"></i> Analytics
                </a>
                <a href="#" class="menu-item">
                    <i class="fas fa-cog"></i> Settings
                </a>
                <hr class="menu-divider">
                <a href="{{ url_for('logout') }}" class="menu-item logout">
                    <i class="fas fa-sign-out-alt"></i> Sign Out
                </a>
            </div>
        </div>
    </div>
</nav>

<!-- Main Content -->
<div class="conversation-container">
    <div class="conversation-content">
        <!-- Conversation Header -->
        <div class="conversation-header">
            <div class="conversation-title">
                <h1>{{ conversation.subject }}</h1>
                <p>Application: {{ conversation.application.company_name }}</p>
            </div>
            <div class="conversation-actions">
                <a href="{{ url_for('corporate_application_detail', app_id=conversation.application_id) }}" 
                   class="btn btn-secondary">
                    <i class="fas fa-file"></i> View Application
                </a>
            </div>
        </div>

        <!-- Messages -->
        <div class="messages-container" id="messagesContainer">
            {% for message in messages %}
            <div class="message {% if message.sender_type == 'corporate' %}sent{% else %}received{% endif %}">
                <div class="message-header">
                    <div class="message-sender">
                        {% if message.sender_type == 'corporate' %}
                        <i class="fas fa-building"></i> {{ message.sender.company_name }}
                        {% else %}
                        <i class="fas fa-user"></i> {{ message.sender.full_name or message.sender.email }}
                        {% endif %}
                    </div>
                    <div class="message-time">
                        {{ message.gmail_timestamp.strftime('%b %d, %Y at %I:%M %p') }}
                    </div>
                </div>
                <div class="message-body">
                    {% if message.html_body %}
                    <div class="message-html">{{ message.html_body|safe }}</div>
                    {% else %}
                    <div class="message-text">{{ message.body|nl2br }}</div>
                    {% endif %}
                </div>
                {% if message.has_attachments %}
                <div class="message-attachments">
                    <i class="fas fa-paperclip"></i> Has attachments
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>

        <!-- Reply Form -->
        <div class="reply-container">
            <form method="POST" action="{{ url_for('send_conversation_reply', conversation_id=conversation.id) }}" class="reply-form">
                <div class="reply-header">
                    <h3>Reply to {{ conversation.applicant.full_name or conversation.applicant.email }}</h3>
                </div>
                <textarea name="message" placeholder="Type your message..." required class="reply-textarea" rows="6"></textarea>
                <div class="reply-actions">
                    <button type="button" onclick="insertTemplate()" class="btn btn-secondary">
                        <i class="fas fa-clipboard"></i> Insert Template
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-paper-plane"></i> Send Reply
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Template Modal -->
<div id="templateModal" class="modal" style="display: none;">
    <div class="modal-content">
        <h3>Message Templates</h3>
        <div class="templates-list">
            <div class="template-item" onclick="selectTemplate('interview_invite')">
                <h4>Interview Invitation</h4>
                <p>Invite candidate for interview</p>
            </div>
            <div class="template-item" onclick="selectTemplate('request_documents')">
                <h4>Request Additional Documents</h4>
                <p>Ask for missing documents</p>
            </div>
            <div class="template-item" onclick="selectTemplate('status_update')">
                <h4>Application Status Update</h4>
                <p>Provide status update to candidate</p>
            </div>
            <div class="template-item" onclick="selectTemplate('rejection')">
                <h4>Application Declined</h4>
                <p>Inform candidate of rejection</p>
            </div>
        </div>
        <button onclick="closeTemplateModal()" class="btn btn-secondary">Cancel</button>
    </div>
</div>

<!-- Footer -->
<footer class="main-footer">
    <div class="footer-inner">
        <div class="footer-brand">
            <div class="logo-container">
                <div class="word">
                    <div class="letter-box red">
                        <div class="letter">C</div>
                    </div>
                    <div class="word-text">ode</div>
                </div>
                <div class="word">
                    <div class="letter-box blue">
                        <div class="letter">C</div>
                    </div>
                    <div class="word-text">raft</div>
                </div>
                <div class="word">
                    <div class="letter-box orange">
                        <div class="letter">C</div>
                    </div>
                    <div class="word-text">o</div>
                </div>
            </div>
            <div class="footer-tagline">Empowering careers through technology</div>
        </div>

        <div class="footer-links">
            <a href="{{ url_for('index') }}">Home</a>
            <a href="{{ url_for('contact_us') }}">Contact</a>
            <a href="{{ url_for('privacy_policy') }}">Privacy</a>
            <a href="{{ url_for('terms_of_service') }}">Terms</a>
            <a href="{{ url_for('help_center') }}">Help</a>
        </div>

        <div class="footer-social">
            <a href="#" class="social-btn linkedin"><i class="fab fa-linkedin-in"></i></a>
            <a href="#" class="social-btn github"><i class="fab fa-github"></i></a>
            <a href="#" class="social-btn instagram"><i class="fab fa-instagram"></i></a>
            <a href="#" class="social-btn facebook"><i class="fab fa-facebook-f"></i></a>
            <a href="#" class="social-btn whatsapp"><i class="fab fa-whatsapp"></i></a>
        </div>
    </div>

    <div class="footer-bottom">
        © 2024 CodeCraftCo. All rights reserved. | Built with ❤️ for South African learners
    </div>
</footer>
{% endblock %}

{% block additional_scripts %}
<script>
function toggleUserMenu() {
    const dropdown = document.getElementById('userMenuDropdown');
    dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
}

// Close dropdown when clicking outside
document.addEventListener('click', function (event) {
    const userMenu = document.querySelector('.user-menu');
    const dropdown = document.getElementById('userMenuDropdown');

    if (!userMenu.contains(event.target)) {
        dropdown.style.display = 'none';
    }
});

// Real-time inbox updates
function updateInboxCounts() {
    fetch('/api/corporate/inbox/unread-count')
        .then(response => response.json())
        .then(data => {
            const unreadCount = data.unread_count || 0;
            
            // Update all inbox badges
            const badges = [
                document.getElementById('navInboxBadge'),
                document.getElementById('menuInboxBadge')
            ];

            badges.forEach(badge => {
                if (badge) {
                    if (unreadCount > 0) {
                        badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
                        badge.style.display = 'flex';
                    } else {
                        badge.style.display = 'none';
                    }
                }
            });

            // Update page title
            if (unreadCount > 0) {
                document.title = `(${unreadCount}) Conversation - {{ conversation.subject }} - CodeCraftCo`;
            } else {
                document.title = 'Conversation - {{ conversation.subject }} - CodeCraftCo';
            }
        })
        .catch(error => console.log('Inbox update error:', error));
}

// Auto-scroll to bottom of messages
document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('messagesContainer');
    container.scrollTop = container.scrollHeight;

    // Initialize inbox updates
    updateInboxCounts();
    setInterval(updateInboxCounts, 30000); // Update every 30 seconds

    // Load draft on page load
    const draft = localStorage.getItem('draft_{{ conversation.id }}');
    if (draft) {
        document.querySelector('.reply-textarea').value = draft;
    }

    // Auto-hide any flash messages
    setTimeout(function () {
        const flashMessages = document.querySelectorAll('.flash-message');
        flashMessages.forEach(function (message) {
            message.style.opacity = '0';
            message.style.transform = 'translateY(-20px)';
            setTimeout(() => message.remove(), 300);
        });
    }, 5000);
});

// Template functions
function insertTemplate() {
    document.getElementById('templateModal').style.display = 'flex';
}

function closeTemplateModal() {
    document.getElementById('templateModal').style.display = 'none';
}

function selectTemplate(templateType) {
    const templates = {
        interview_invite: `Dear {{ conversation.applicant.full_name or conversation.applicant.email }},

Thank you for your interest in our learnership program. We would like to invite you for an interview.

Please let us know your availability for the following time slots:
- [Date/Time Option 1]
- [Date/Time Option 2]
- [Date/Time Option 3]

The interview will be conducted [virtually/at our office] and will take approximately [duration].

Best regards,
{{ corporate_user.company_name if corporate_user and corporate_user.company_name else 'CodeCraftCo Team' }}`,
        
        request_documents: `Dear {{ conversation.applicant.full_name or conversation.applicant.email }},

Thank you for your application. To proceed with your application, we need the following additional documents:

- [Document 1]
- [Document 2]
- [Document 3]

Please reply to this email with the requested documents attached.

Best regards,
{{ corporate_user.company_name if corporate_user and corporate_user.company_name else 'CodeCraftCo Team' }}`,
        
        status_update: `Dear {{ conversation.applicant.full_name or conversation.applicant.email }},

We wanted to provide you with an update on your application for our learnership program.

Your application is currently [status] and [next steps].

We expect to complete our review process by [date]. We will contact you as soon as we have more information.

Best regards,
{{ corporate_user.company_name if corporate_user and corporate_user.company_name else 'CodeCraftCo Team' }}`,
        
        rejection: `Dear {{ conversation.applicant.full_name or conversation.applicant.email }},

Thank you for your interest in our learnership program and for taking the time to apply.

After careful consideration, we regret to inform you that we will not be moving forward with your application at this time. This decision was difficult as we received many qualified applications.

We encourage you to apply for future opportunities that match your skills and experience.

Best regards,
{{ corporate_user.company_name if corporate_user and corporate_user.company_name else 'CodeCraftCo Team' }}`
    };
    
    const textarea = document.querySelector('.reply-textarea');
    textarea.value = templates[templateType];
    closeTemplateModal();
    textarea.focus();
}

// Auto-save draft
let draftTimer;
function saveDraft() {
    clearTimeout(draftTimer);
    draftTimer = setTimeout(() => {
        const message = document.querySelector('.reply-textarea').value;
        if (message.trim()) {
            localStorage.setItem('draft_{{ conversation.id }}', message);
        }
    }, 1000);
}

// Clear draft on send
document.querySelector('.reply-form').addEventListener('submit', function(e) {
    // Show loading state
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
    submitBtn.disabled = true;

    // Show custom loading if available
    if (window.showCustomLoading) {
        window.showCustomLoading('Sending Reply', 'Your message is being sent...');
    }

    // Clear draft
    localStorage.removeItem('draft_{{ conversation.id }}');
});

document.querySelector('.reply-textarea').addEventListener('input', saveDraft);

// Close modal when clicking outside
document.getElementById('templateModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeTemplateModal();
    }
});

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Ctrl/Cmd + Enter to send message
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        const form = document.querySelector('.reply-form');
        if (form) {
            form.submit();
        }
    }
    
    // Escape to close modal
    if (e.key === 'Escape') {
        closeTemplateModal();
    }
});
</script>
{% endblock %}