{% extends "base.html" %}
{% block title %}Analytics - CodeCraftCo{% endblock %}
{% block content %}
<div class="analytics-container">
  <!-- NAVIGATION -->
  <nav class="dashboard-nav" role="navigation" aria-label="Main navigation">
    <div class="nav-left">
      <h2 class="nav-logo">
        <a href="{{ url_for('user_dashboard') }}" aria-label="CodeCraftCo Dashboard">
          <div class="logo-container">
            <div class="word">
              <div class="letter-box red">
                <div class="letter">C</div>
              </div>
              <div class="word-text">ode</div>
            </div>
            <div class="word">
              <div class="letter-box blue">
                <div class="letter">C</div>
              </div>
              <div class="word-text">raft</div>
            </div>
            <div class="word">
              <div class="letter-box orange">
                <div class="letter">C</div>
              </div>
              <div class="word-text">o</div>
            </div>
          </div>
        </a>
      </h2>
    </div>

    <div class="nav-right">
            {% if current_user.is_admin %}
      <a href="{{ url_for('premium_management') }}" class="nav-admin-link" aria-label="Premium Management">
        <i class="fas fa-crown" style="color: #f093fb;"></i>
        <span>Premium Management</span>
        <small class="badge">{{ premium_count or 0 }}</small>
      </a>
      {% endif %}
      <a href="{{ url_for('user_dashboard') }}" class="nav-dashboard-link" aria-label="Go to Dashboard">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="18" height="18"
          class="dash-icon">
          <path d="M3 9.75 12 3l9 6.75V20a1 1 0 0 1-1 1h-5v-6H9v6H4a1 1 0 0 1-1-1V9.75Z" />
        </svg>
        <span>Dashboard</span>
      </a>

      <!-- User / Account Menu -->
      <div class="user-menu">
        <button class="user-menu-trigger" aria-haspopup="true" aria-expanded="false">
          <div class="user-avatar-small">
            {% if current_user.profile_picture %}
            <img src="{{ current_user.profile_picture }}" alt="">
            {% else %}
            <span>{{ (current_user.full_name or current_user.email)[0].upper() }}</span>
            {% endif %}
          </div>
          <span class="user-name">{{ current_user.full_name or current_user.email }}</span>
          <svg class="chevron-icon" viewBox="0 0 20 20" fill="currentColor" width="16" height="16">
            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0
                           111.414 1.414l-4 4a1 1 0 01-1.414
                           0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
          </svg>
        </button>
        <div class="user-menu-dropdown" role="menu">
          <a href="{{ url_for('edit_profile') }}" class="menu-item" role="menuitem">Profile Settings</a>
          <div class="menu-divider"></div>
          <a href="{{ url_for('logout') }}" class="menu-item logout" role="menuitem">Logout</a>
        </div>
      </div>
    </div>
  </nav>

  <!-- ANALYTICS BODY -->
  <main class="analytics-content">
    <section class="welcome-section">
      <h1>Application Analytics</h1>
      <p>Visual performance overview of your applications and responses</p>
    </section>

    <!-- BAR CHART -->
    <section class="chart-card glass-effect">
      <div class="chart-head">Status Distribution</div>
      <div class="chart-container bar-container">
        <div class="y-axis-label axis-label">Applications</div>
        <div class="bar-wrapper" id="barChart"></div>
        <div class="x-axis-label axis-label">Statuses</div>
      </div>
    </section>

    <!-- LINE CHART -->
    <section class="chart-card glass-effect">
      <div class="chart-head">Response Growth</div>
      <div class="chart-container line-container">
        <div class="y-axis-label axis-label">Responses</div>
        <svg id="lineChart" class="line-svg"></svg>
        <div class="x-axis-label axis-label">Weeks</div>
      </div>
    </section>

    <!-- PIE CHART -->
    <section class="chart-card glass-effect">
      <div class="chart-head">Overall Status Breakdown</div>
      <div class="pie-wrap">
        <svg id="pieChart" class="pie-svg" viewBox="0 0 200 200"></svg>
        <div id="legend" class="legend"></div>
      </div>
    </section>
    
  </main>
  <!-- ======= FOOTER ======= -->
<footer class="main-footer">
  <div class="footer-inner">
    <!-- Brand -->
    <div class="footer-brand">
      <div class="logo-container">
        <div class="word">
          <div class="letter-box red"><div class="letter">C</div></div>
          <div class="word-text">ode</div>
        </div>
        <div class="word">
          <div class="letter-box blue"><div class="letter">C</div></div>
          <div class="word-text">raft</div>
        </div>
        <div class="word">
          <div class="letter-box orange"><div class="letter">C</div></div>
          <div class="word-text">o</div>
        </div>
      </div>
      <p class="footer-tagline">Empowering developers with smart tools.</p>
    </div>

    <!-- Links -->
    <div class="footer-links">
      <a href="{{ url_for('user_dashboard') }}">Dashboard</a>
      <a href="{{ url_for('edit_profile') }}">Profile</a>
      <a href="#">Contact</a>
      <a href="#">Privacy</a>
      <a href="#">Terms</a>
    </div>

    <!-- Social -->
    <div class="footer-social">
      <a href="#" aria-label="LinkedIn" class="social-btn linkedin"><i class="fa-brands fa-linkedin-in"></i></a>
      <a href="#" aria-label="GitHub" class="social-btn github"><i class="fa-brands fa-github"></i></a>
      <a href="#" aria-label="Instagram" class="social-btn instagram"><i class="fa-brands fa-instagram"></i></a>
      <a href="#" aria-label="Facebook" class="social-btn facebook"><i class="fa-brands fa-facebook-f"></i></a>
      <a href="#" aria-label="WhatsApp" class="social-btn whatsapp"><i class="fa-brands fa-whatsapp"></i></a>
    </div>
  </div>

  <div class="footer-bottom">
    <p>Â© {{ current_year or 2024 }} <strong>CodeCraftCo</strong>. All rights reserved.</p>
  </div>
</footer>
</div>

<script>
  const statusSummary = {{ status_summary| tojson }};
  const responseTrend = {{ response_trend| tojson }};

  /* Distinct color palette per status */
  const colorScheme = ["#22c55e", "#3b82f6", "#f97316", "#eab308", "#ef4444", "#a855f7"];

  function renderBar() {
    const box = document.getElementById('barChart');
    box.innerHTML = '';
    const max = Math.max(...statusSummary.map(s => s.value || 0), 1);
    const barHeight = box.clientHeight * 0.9;
    statusSummary.forEach((s, i) => {
      const h = (s.value / max) * barHeight;
      const clr = colorScheme[i % colorScheme.length];
      const div = document.createElement('div');
      div.className = 'bar';
      div.innerHTML = `
     <div class="barcol" style="height:${h}px;background:linear-gradient(180deg,${clr} 0%,${clr}bb 100%)">
       <div class="barval">${s.value}</div>
     </div>
     <div class="barlabel">${s.label}</div>`;
      box.appendChild(div);
    });
  }

  function renderLine() {
    const svg = document.getElementById('lineChart');
    const container = svg.parentElement;
    const width = container.clientWidth || 580;
    const height = Math.max(180, container.clientWidth * 0.4);
    const pad = 36;
    svg.setAttribute('viewBox', `0 0 ${width} ${height}`); svg.innerHTML = '';
    const max = Math.max(...responseTrend, 1);
    const pts = responseTrend.map((v, i) => {
      const x = pad + (i / (responseTrend.length - 1 || 1)) * (width - 2 * pad);
      const y = height - pad - (v / max) * (height - 2 * pad);
      return [x, y];
    });
    const make = (t, a) => { const e = document.createElementNS("http://www.w3.org/2000/svg", t); for (let k in a) e.setAttribute(k, a[k]); return e; }
    svg.append(make("line", { x1: pad, y1: height - pad, x2: width - pad, y2: height - pad, stroke: "#475569" }),
      make("line", { x1: pad, y1: pad, x2: pad, y2: height - pad, stroke: "#475569" }));
    const path = make("path", {
      d: pts.map((p, i) => `${i ? 'L' : 'M'}${p[0]},${p[1]}`).join(' '),
      stroke: "#3b82f6", fill: "none", "stroke-width": "2.5", "stroke-linecap": "round"
    });
    svg.appendChild(path);
    pts.forEach((p, i) => {
      svg.appendChild(make("circle", { cx: p[0], cy: p[1], r: 3.5, stroke: "#f59e0b", fill: "#1e293b" }));
      const lbl = make("text", { x: p[0], y: height - pad + 14, fill: "#94a3b8", "font-size": "10", "text-anchor": "middle" });
      lbl.textContent = `W${i + 1}`; svg.appendChild(lbl);
    });
  }

  function renderPie() {
    const svg = document.getElementById('pieChart'); svg.innerHTML = '';
    const legend = document.getElementById('legend'); legend.innerHTML = '';
    const cx = 100, cy = 100, r = 80, total = statusSummary.reduce((a, b) => a + b.value, 0) || 1;
    let start = 0;
    statusSummary.forEach((s, i) => {
      const angle = (s.value / total) * 2 * Math.PI, end = start + angle;
      const x1 = cx + r * Math.cos(start), y1 = cy + r * Math.sin(start);
      const x2 = cx + r * Math.cos(end), y2 = cy + r * Math.sin(end);
      const large = angle > Math.PI ? 1 : 0;
      const path = `M${cx},${cy} L${x1},${y1} A${r},${r} 0 ${large} 1 ${x2},${y2} Z`;
      const clr = colorScheme[i % colorScheme.length];
      const p = document.createElementNS("http://www.w3.org/2000/svg", "path");
      p.setAttribute("d", path); p.setAttribute("fill", clr);
      svg.appendChild(p); start = end;
      const li = document.createElement("div");
      li.className = "legend-item";
      li.innerHTML = `<div class="legend-dot" style="background:${clr}"></div>
                <div class="legend-text">${s.label}</div>
                <div class="legend-val">${s.value}</div>`;
      legend.appendChild(li);
    });
  }

  function renderAll() { renderBar(); renderLine(); renderPie(); }
  window.addEventListener('resize', renderAll);
  window.addEventListener('load', renderAll);
</script>

<style>
  :root {
    --background: #1e293b;
    --surface: #334155;
    --surface-hover: #475569;
    --border-color: #475569;
    --text-primary: #f8fafc;
    --text-secondary: #cbd5e1;
  }

  body {
    background: var(--background);
    color: var(--text-primary);
    font-family: Inter, Arial, sans-serif;
    margin: 0;
  }

  .dashboard-nav {
    background: var(--surface);
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 24px;
  }

  .logo-container {
    display: flex;
    align-items: center;
    gap: 4px;
  }

  /* Logo styles */
  .nav-logo {
    margin: 0;
    padding: 0;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: flex-start;
  }

  .nav-logo a {
    text-decoration: none;
    display: flex;
    align-items: center;
    height: 100%;
  }

  .logo-container {
    display: flex;
    align-items: center;
    gap: 4px;
    background: transparent;
    transform: translateY(16px);
  }

  .word {
    display: flex;
    align-items: center;
  }

.letter-box {
    width: 35px;
    height: 35px;
    background-color: rgba(51, 51, 51, 0.9);
    border: 2px solid #fff;
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
    backdrop-filter: blur(10px);
}

.letter-box.red {
    box-shadow: 0 0 12px #ff0000, 0 0 24px #ff0000;
}

.letter-box.blue {
    box-shadow: 0 0 12px #0099ff, 0 0 24px #0099ff;
}

.letter-box.orange {
    box-shadow: 0 0 12px #ff8800, 0 0 24px #ff8800;
}

.letter {
    font-size: 20px;
    font-weight: bold;
    color: #fff;
    text-align: center;
    font-family: 'Arial', sans-serif;
    line-height: 1;
}

.word-text {
    font-size: 20px;
    font-weight: normal;
    color: #fff;
    margin-left: 3px;
    font-family: 'Arial', sans-serif;
    text-shadow: 0 0 5px rgba(255, 255, 255, 0.3);
    line-height: 1;
}
  .nav-dashboard-link {
    display: flex;
    align-items: center;
    gap: 6px;
    text-decoration: none;
    color: white;
    background: var(--surface-hover);
    padding: 6px 12px;
    border-radius: 8px;
    transition: all .3s;
  }

  .nav-dashboard-link:hover {
    background: #64748b;
  }

  .user-menu {
    position: relative;
    display: flex;
    align-items: center;
  }

  .user-menu-trigger {
    display: flex;
    align-items: center;
    gap: 6px;
    background: none;
    border: none;
    cursor: pointer;
  }

  .user-avatar-small img {
    width: 34px;
    height: 34px;
    border-radius: 50%;
    object-fit: cover;
  }

  .user-avatar-small span {
    width: 34px;
    height: 34px;
    border-radius: 50%;
    background: var(--surface-hover);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
  }

  .user-name {
    font-size: 0.9rem;
    color: white;
  }

  .user-menu-dropdown {
    display: none;
    position: absolute;
    right: 0;
    top: 44px;
    background: var(--surface);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    min-width: 160px;
    z-index: 10;
  }

  .user-menu-trigger:hover+.user-menu-dropdown,
  .user-menu-dropdown:hover {
    display: block;
  }

  .menu-item {
    display: block;
    padding: 10px 14px;
    color: white;
    text-decoration: none;
  }

  .menu-item:hover {
    background: var(--surface-hover);
  }

  .menu-divider {
    height: 1px;
    background: var(--border-color);
  }

  .logout {
    color: #ef4444;
  }

  .analytics-content {
    max-width: 1100px;
    margin: 50px auto 30px;
    padding: 0 20px;
  }

  .welcome-section h1 {
    font-size: 1.5rem;
    margin-bottom: 6px;
  }

  .welcome-section p {
    color: var(--text-secondary);
    margin-bottom: 30px;
    font-size: 0.9rem;
  }

  .chart-card {
    background: var(--surface);
    border: 1px solid var(--border-color);
    border-radius: 10px;
    padding: 16px;
    margin-bottom: 30px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
  }

  .chart-card.glass-effect {
    background-color: rgba(51, 65, 85, 0.85);
    backdrop-filter: blur(6px);
  }

  .chart-head {
    font-weight: 600;
    margin-bottom: 14px;
    font-size: 1rem;
  }

  .bar-wrapper {
    display: flex;
    align-items: flex-end;
    justify-content: space-evenly;
    height: 270px;
    border-left: 1px solid var(--border-color);
    border-bottom: 1px solid var(--border-color);
  }

  .bar {
    text-align: center;
    flex: 1;
    max-width: 90px;
  }

  .barcol {
    width: 50%;
    min-width: 20px;
    margin: 0 auto;
    border-radius: 6px 6px 0 0;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.25);
    transition: transform .3s;
  }

  .barcol:hover {
    transform: translateY(-5px);
  }

  .barval {
    font-size: 0.8rem;
    position: relative;
    top: -18px;
    color: white;
    font-weight: 600;
  }

  .barlabel {
    font-size: 0.75rem;
    color: var(--text-secondary);
    margin-top: 5px;
  }

  .line-svg {
    width: 100%;
    height: 220px;
  }

  #lineChart path {
    stroke-width: 2.5;
    stroke-linecap: round;
    filter: drop-shadow(0 0 4px #60a5fa80);
  }

  #lineChart circle {
    stroke-width: 2;
    fill: var(--background);
  }

  .axis-label {
    color: var(--text-secondary);
    font-size: 12px;
  }

  .x-axis-label {
    position: absolute;
    bottom: 2px;
    left: 50%;
    transform: translateX(-50%);
  }

  .y-axis-label {
    position: absolute;
    left: -18px;
    top: 50%;
    transform: translate(-50%, -50%) rotate(-90deg);
  }

  .pie-wrap {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding-block: 8px 10px;
  }

  .pie-svg {
    width: clamp(140px, 22vw, 200px);
    height: clamp(140px, 22vw, 200px);
  }

  #pieChart path {
    stroke: #1e293b;
    stroke-width: 1px;
    transition: transform .25s;
  }

  #pieChart path:hover {
    transform: scale(1.05);
    transform-origin: center;
  }

  .legend {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    margin-top: 6px;
    gap: 8px;
    max-width: 360px;
  }

  .legend-item {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 0.8rem;
  }

  .legend-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
  }

  @media (max-width:768px) {
    .bar-wrapper {
      height: 210px;
    }

    .pie-svg {
      width: 160px;
      height: 160px;
    }
  }

  @media (max-width:480px) {
    .bar-wrapper {
      height: 160px;
    }

    .barlabel {
      font-size: 0.7rem;
    }

    .pie-svg {
      width: 140px;
      height: 140px;
    }
  }

  
  /* ---------- FOOTER (final compact layout) ---------- */
.main-footer {
  background:#1e293b;
  border-top:1px solid var(--border-color);
  color:var(--text-secondary);
  padding:20px 12px 12px;
  margin-top:36px;
}

.footer-inner {
  display:flex;
  align-items:center;
  justify-content:space-between;
  flex-wrap:wrap;
  max-width:1100px;
  margin:0 auto;
  gap:8px;
}

/* Brand */
.footer-brand {
  flex:1 1 180px;
  text-align:center;
}
.footer-brand .logo-container {
  justify-content:center;
  transform:scale(0.9);
}
.footer-tagline {
  font-size:0.78rem;
  color:var(--text-tertiary);
  margin-top:3px;
}

/* Links */
.footer-links {
  flex:1 1 260px;
  display:flex;
  flex-wrap:wrap;
  justify-content:center;
  gap:6px 10px;
}
.footer-links a {
  color:var(--text-secondary);
  font-size:0.8rem;
  text-decoration:none;
  transition:color 0.3s;
}
.footer-links a:hover { color:var(--text-primary); }

/* Socials */
.footer-social {
  flex:1 1 140px;
  display:flex;
  justify-content:center;
  align-items:center;
  gap:6px;
  margin-top:2px;
}
.social-btn {
  width:22px;
  height:22px;
  display:flex;
  align-items:center;
  justify-content:center;
  border-radius:50%;
  background:var(--surface-hover);
  color:white;
  font-size:11px;
  transition:transform .25s ease, background .25s ease;
}
.social-btn:hover { transform:translateY(-2px); }
.social-btn.linkedin:hover { background:#0077b5; }
.social-btn.github:hover { background:#181717; }
.social-btn.instagram:hover { 
  background:radial-gradient(circle at 30% 107%,#fdf497 0%,#fd5949 45%,#d6249f 60%,#285AEB 90%);
}
.social-btn.facebook:hover { background:#1877f2; }
.social-btn.whatsapp:hover { background:#25D366; }

/* Bottom */
.footer-bottom {
  border-top:1px solid var(--border-color);
  text-align:center;
  padding-top:6px;
  margin-top:6px;
  font-size:0.72rem;
  color:var(--text-tertiary);
}

/* ---------- RESPONSIVE ---------- */
@media (max-width:768px){
  .main-footer {
    padding:8px 6px 8px !important; /* tighter padding */
  }

  .footer-inner {
    flex-direction:column;
    align-items:center;
    gap:2px !important; /* reduced spacing */
  }

  .footer-brand { margin-bottom:0 !important; }
  .footer-tagline {
    margin-top:2px;
    font-size:0.74rem;
  }

  .footer-links {
    order:3;
    margin-top:2px !important;
    gap:3px 6px !important;
  }

  .footer-social {
    order:2;
    margin-top:0 !important;
    gap:4px !important;
  }

  .social-btn {
    width:20px;
    height:20px;
    font-size:10px;
  }
}

@media (max-width:420px){
  .footer-tagline { display:none; }

  .footer-inner { gap:1px !important; }

  .footer-links a { font-size:0.75rem; }

  .social-btn {
    width:18px;
    height:18px;
    font-size:9.5px;
  }

  .main-footer {
    padding:6px 4px 4px !important;
  }
}
.nav-admin-link {
  display: flex;
  align-items: center;
  gap: 6px;
  text-decoration: none;
  color: white;
  background: linear-gradient(45deg, #f093fb 0%, #f5576c 100%);
  padding: 6px 12px;
  border-radius: 8px;
  transition: all .3s;
  margin-right: 10px;
}

.nav-admin-link:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(240, 147, 251, 0.4);
  color: white;
}

.nav-admin-link .badge {
  background: rgba(255, 255, 255, 0.3);
  color: white;
  padding: 0.2rem 0.5rem;
  border-radius: 10px;
  font-size: 0.7rem;
  font-weight: bold;
}
</style>
{% endblock %}